<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
      <th:bolck layout:fragment="content">
<head>
	<meta charset="UTF-8">

	<title>매장찾기</title>

	<!-- Google Font -->
	<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap"
		rel="stylesheet">
	<!-- 스크롤 style -->
	<style>
		.basic-scroll::-webkit-scrollbar {
			width: 8px;
			height: 8px;
			background: #ffffff;
		}

		.basic-scroll::-webkit-scrollbar-thumb {
			border-radius: 3.5px;
			background-color: #469543;
		}

		.basic-scroll::-webkit-scrollbar-thumb:hover {
			background-color: #adb5bd;
		}

		.basic-scroll::-webkit-scrollbar-track {
			background: #ffffff;
		}
	</style>


</head>

<body>
	<section class="breadcrumb-option">
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					<div class="breadcrumb__text">
						<h4>매장찾기</h4>
						<div class="breadcrumb__links">
							<a href="/">Home</a><span>매장찾기</span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
	<!-- 서브 타이틀 끝 -->

	<!-- 맵 생성 및 위에 있는 div -->
	<div class="map-wrapper">
		<div id="map" style="width: 100%; height: 700px; background: #fff;" class="map-container"></div>
		<div class="table-container"
			style="width: 400px; height: 650px; background: #fff; padding: 30px; margin: 20px; border: 1px solid #469543;">
			<div>
				<form id="search-form">
					<div class="shop__sidebar__search">
						<input type="text" id="search-input" name="keyword" placeholder="지역 또는 매장명 입력">
						<button type="submit" id="search-btn">
							<span class="icon_search"></span>
						</button>
					</div>
				</form>
				<p style="font-size: 13px; color: #919191; text-align: center">*
					운영시간은 매장 사정에 따라 변경될 수 있습니다.</p>
				<hr>
				<div class="basic-scroll" style="width: 340px; height: 470px; overflow-x: hidden;">
					<table id="table">
						<thead>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
	<!-- 맵 생성 및 위에 있는 div 끝 -->

	<!-- 신규매장 -->
	<section class="blog-hero spad">
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					<div class="section-title">
						<h2>신규매장안내</h2>
						<br>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-4 col-md-6 col-sm-6">
					<div class="blog__item">
						<div class="blog__item__text">
							<span> 서울특별시</span>
							<h5>을지로3가</h5>
							<a href="#">OPEN 2023-03-27</a>
						</div>
					</div>
				</div>
				<div class="col-lg-4 col-md-6 col-sm-6">
					<div class="blog__item">
						<div class="blog__item__text">
							<span> 서울특별시</span>
							<h5>광화문</h5>
							<a href="#">COMING SOON</a>
						</div>
					</div>
				</div>
				<div class="col-lg-4 col-md-6 col-sm-6">
					<div class="blog__item">
						<div class="blog__item__text">
							<span> 서울특별시</span>
							<h5>종로3가</h5>
							<a href="#">COMING SOON</a>
						</div>
					</div>
				</div>
			</div>

		</div>
	</section>
	<!-- 신규매장 끝 -->


	<a id="storeList"></a>
	<!-- 전체매장 -->
	<section class="shop spad">
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					<div class="section-title">
						<h2>전체매장</h2>
						<br>
					</div>


					<div class="shop__product__option">
						<div class="row">
							<!-- 전체매장 카운트 -->
							<div class="col-lg-8 col-md-12 col-sm-6">
								<div class="shop__product__option__left">
									<div class="nowrap">
										총 <span class="total-count">
											<a th:text="${paging.totalElements}"></a>
										</span> 개 매장이 있습니다.
									</div>
								</div>
							</div>
							<!-- 전체매장 카운트 끝 -->
							<!-- 전체매장 검색 -->
							<div class="col-lg-4 col-md-6 col-sm-6">
								<div class="shop__sidebar__search">
									<form id="searchForm" method="get" action="/store/list#storeList2">
										<div class="form-group d-flex align-items-center">
											<input name="keyword" type="text" placeholder="지역 또는 매장명 입력" value=""
												class="form-control">
											<button type="submit" class="btn btn-primary ml-2">
												<span class="icon_search"></span> 검색
											</button>
										</div>
									</form>
								</div>
							</div>
							<!-- 전체매장 검색 끝 -->
						</div>
					</div>
					<!--전체매장 카운트 끝-->

					<table class="table">
						<thead>
							<tr>
								<th class="green" scope="col">NO</th>
								<th class="green" scope="col">매장명</th>
								<th class="green" scope="col">매장주소</th>
								<th class="green" scope="col">연락처</th>
								<th></th>
								<th class="green" scope="col" th:if="${memberId eq 'admin@0'}">수정</th>
								<th class="green" scope="col" th:if="${memberId eq 'admin@0'}">삭제</th>
							</tr>
						</thead>
						<tbody th:if="${paging.isEmpty()}">
							<tr>
								<td colspan="7" align="center">등록된 매장이 없습니다.</td>
							</tr>
						</tbody>
						<tbody class="table-group-divider" th:if="${!paging.isEmpty()}">
							<tr th:each="store, loop : ${paging}">
								<td scope="row" class="num"><a th:text="${store.storeId}"></a></td>
								<td><a th:text="${store.storeName}"></a></td>
								<td class="left"><a th:text="${store.storeAddress}"></a></td>
								<td><a th:text="${store.storeTel}"></a></td>
								<td>
									<form action="/product/list" method="post" name="storeNamemenu">
										<input type="submit"
											style="background-color: #469543; color: #fff; border-radius: 30px; padding: 5px 7px; border: none; margin: 0 auto; font-size: 12px;"
											value="주문">
										<input type="hidden" name="storeName" th:value="${store.storeName}">
										<input type="hidden" name="storeId" th:value="${store.storeId}">
										<input type="hidden" name="storeAddress" th:value="${store.storeAddress}">
									</form>
								</td>
								<td th:if="${memberId eq 'admin@0'}">
									<input type="button"
										onclick="location.href='/store/modify?storeId=${store.storeId}'"
										style="background-color: #469543; color: #fff; border-radius: 30px; padding: 5px 7px; border: none; margin: 0 auto; font-size: 12px;"
										value="수정">
								</td>
								<td th:if="${memberId eq 'admin@0'}">
									<form action="${pageContext.request.contextPath}/store/deleteProcess#storeList2"
										method="get">
										<input type="hidden" name="storeId" th:value="${store.storeId}">
										<input type="submit" value="삭제" onclick="return confirm('정말로 삭제하시겠습니까?');"
											style="background-color: #469543; color: #fff; border-radius: 30px; padding: 5px 7px; border: none; margin: 0 auto; font-size: 12px;">
									</form>
								</td>
							</tr>
						</tbody>
					</table>
					<!-- 전체매장 테이블-->

					<!-- 페이징처리 시작 -->
					<div class="row">
						<div class="col-lg-12">
							<div th:if="${!paging.isEmpty()}" class="product__pagination">
								<form id='actionForm' action="/store/list#storeList2" method='get'></form>
								<span class="paginate_button prev" th:classappend="${!paging.hasPrevious} ? 'disabled'">
									<a th:href="@{|?page=${paging.number-1}&keyword=${keyword}#storeList2|}" th:if="${paging.hasPrevious}">
										이전
									</a>
								</span>
								<span th:each="page: ${#numbers.sequence(0, paging.totalPages-1)}"
									th:if="${page >= paging.number-5 and page <= paging.number+5}"
									th:classappend="${page == paging.number} ? 'active'" class="paginate_button active">
									<a th:text="${page}" class="paginate_button"
										th:href="@{|?page=${page}&keyword=${keyword}#storeList2|}"></a>
								</span>
								<span class="paginate_button next" th:classappend="${!paging.hasNext} ? 'disabled'">
									<a th:href="@{|?page=${paging.number+1}&keyword=${keyword}#storeList2|}" th:if="${paging.hasNext}">
										다음
									</a>
								</span>
							</div>
						</div>
					</div>
					<!-- 페이징처리 끝 -->
					<!-- 전체매장 버튼 -->
					<div class="col-lg-12">
						<div class="product__pagination">
							<c:if test="${memberId eq 'admin@0' }">
								<button type="submit" onclick="location.href='/store/register'"
									style="background-color: #469543; color: #fff; border-radius: 30px; padding: 7px 10px; border: none; margin: 0 auto; font-size: 13px;">
									매장등록</button>
							</c:if>
							<button onclick="location.href='/store/list#storeList'"
								style="background-color: #469543; color: #fff; border-radius: 30px; padding: 7px 10px; border: none; margin: 0 auto; font-size: 13px;">
								목록보기</button>
						</div>
					</div>
					<!-- 전체매장 끝 -->

				</div>
			</div>
		</div>
	</section>
	<!-- 전체매장 끝 -->
	<a id="storeList2"></a>
</body>
<script type="text/javascript" src="//openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=plyv9nfbr0"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"
	integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>



<script type="text/javascript">

	/*var searchForm = $("#searchForm");

	$("#searchForm button").on("click", function (e) {

		if (!searchForm.find("option:selected").val()) {
			alert("검색종류를 선택하세요.");
			return false;
		
		if (!searchForm.find("input[name='keyword']").val()) {
			alert("키워드를 입력하세요.");
			return false;
		}

		searchForm.find("input[name='pageNum']").val("1");
		e.preventDefault();

		searchForm.submit();

	});*/
</script>

<script>
	/* 사용자의 현재 위치를 가져오고 지도를 중심으로 설정 */
	async function getLocation() {
		let XY = {
			lat: 37.5799,
			lng: 126.9767
		};
		var mapDiv = document.getElementById('map');
		var map = new naver.maps.Map(mapDiv, {
			center: new naver.maps.LatLng(XY.lat, XY.lng),
			zoom: 16
		});

		try {
			let position = await new Promise((resolve, reject) => {
				navigator.geolocation.getCurrentPosition(resolve, reject);
			});
			XY = {
				lat: position.coords.latitude,
				lng: position.coords.longitude
			};
			console.log(XY.lat);
			console.log(XY.lng);
			map.setCenter(new naver.maps.LatLng(XY.lat, XY.lng));
		} catch (error) {
			console.log(error.message);
		}

		return [map, XY];
	}

	$(document).ready(async function () {
		let [map, XY] = await getLocation();

		let markers = [];
		let infowindows = [];

		/* 지도 목록 디자인 & 내용 */
		function createMarkerAndInfoWindow(map, list, params) {
			if (paging.storeName.includes(params.keywords) || paging.storeAddress.includes(params.keywords)) {

				var table = document.getElementById("table");
				var newRow1 = table.insertRow();
				var newRow2 = table.insertRow();
				var newRow3 = table.insertRow();
				var newRow4 = table.insertRow();


				var storeNameCell = newRow1.insertCell(0);
				storeNameCell.style.fontSize = "20px";
				storeNameCell.style.fontWeight = "700";
				storeNameCell.style.color = "#585858";
				storeNameCell.style.cursor = "pointer";
				storeNameCell.innerHTML = paging.storeName;

				var storeAddressCell = newRow2.insertCell(0);
				storeAddressCell.style.fontSize = "13px";
				storeAddressCell.style.color = "#919191";
				storeAddressCell.innerHTML = paging.storeAddress;

				var storeTelCell = newRow3.insertCell(0);
				storeTelCell.style.fontSize = "13px";
				storeTelCell.style.color = "#919191";
				storeTelCell.innerHTML = paging.storeTel;

				var storeOpenCell = newRow4.insertCell(0);
				storeOpenCell.style.fontSize = "13px";
				storeOpenCell.style.color = "#919191";
				storeOpenCell.innerHTML = paging.storeOpen + " ~ " + paging.storeClose;
				newRow4.insertAdjacentHTML('afterend', '<tr><td colspan="4"><hr style="width: 340px"></td></tr>');



				/* 지도마커 생성 디자인, 위치 */
				let marker = new naver.maps.Marker({
					position: new naver.maps.LatLng(paging.storeLat, paging.storeLng),
					map: map,
					title: paging.storeName,
					icon: {
						url: "/resources/img/markerex.png",
						size: new naver.maps.Size(50, 52),
						origin: new naver.maps.Point(0, 0),
						anchor: new naver.maps.Point(20, 26),
					},
				});
				markers.push(marker);
				map.setCenter(marker.getPosition());

				/* 마커 클릭시 나오는 인포윈도우 내부 css와 값 */
				let contentString = [
					'   <span class="close" id="closeBtn" style="position: absolute; top: 10px; right: 15px;">&times;</span>',
					'	<div class="iw_inner" style="margin: 20px; display: flex; align-items: center; justify-content: center;">',
					'   <div>',
					'       <h5 style="text-align: left;">' + paging.storeName + '</h5>',
					'       <table style="font-size: 12px; color: #919191; margin: 10px auto; border-collapse: collapse;">',
					'           <tr><th style="padding-right: 10px;  width: 70px; color: #111">주소</th><td>' + paging.storeAddress + '</td></tr>',
					'           <tr><th style="padding-right: 10px; width: 70px; color: #111">연락처</th><td>' + paging.storeTel + '</td></tr>',
					'           <tr><th style="padding-right: 10px; width: 70px; color: #111">영업시간</th><td>' + paging.storeOpen + ' - ' + paging.storeClose + '</td></tr>',
					'       </table><hr>',
					'       <form method="post" action="/product/list"> <input type="hidden" name="storeName" value="' + paging.storeName + '">',
					'       <input type="hidden" name="storeId" value="' + paging.storeId + '"><input type="hidden" name="storeAddress" value="' + paging.storeAddress + '">',
					'       <div style="text-align: center;">',
					'           <button type="submit" style="background-color: #469543; color: #fff; border-radius: 30px; padding: 10px 20px; border: none; margin: 0 auto;">주문하기</button>',
					'       </div>',
					'       </form>',
					'   </div>',
					'</div>',
				].join("");

				/* 인포윈도우 생성 및 옵션 */
				var infowindow = new naver.maps.InfoWindow({
					content: contentString,
					maxWidth: 300,
					maxHeight: 100,
					backgroundColor: "#fff",
					borderColor: "#469543",
					borderWidth: 1,
					anchorSize: new naver.maps.Size(30, 30),
					anchorSkew: true,
					anchorColor: "#fff",
					pixelOffset: new naver.maps.Point(10, -20),
					contentStyle: {
						overflowY: "scroll",
						minWidth: "300px",
						minHeight: "100px",
						display: "flex",
						flexDirection: "column",
					},
				});

				infowindows.push(infowindow);

				/* 검색했을 때 storeName을 클릭하면 해당 마커로 이동 후 바운스 애니메이션, 인포윈도우 열기 */
				storeNameCell.addEventListener('click', function () {
					map.setCenter({lat: paging.storeLat, lng: paging.storeLng});
					map.setZoom(17);
					marker.setAnimation(naver.maps.Animation.BOUNCE);
					setTimeout(function () {marker.setAnimation(null);}, 2100);
					infowindow.open(map, marker);
					var closeButton = infowindow.getContentElement().querySelector('#closeBtn');
					if (closeButton) {
						closeButton.addEventListener('click', function () {
							infowindow.close();
						});
					}
				});



				/* 마커를 클릭하면 인포윈도우 열고 닫기 */
				naver.maps.Event.addListener(marker, "click", function (e) {
					if (infowindow.getMap()) {
						infowindow.close();
					} else {
						infowindow.open(map, marker);
						var closeButton = infowindow.getContentElement().querySelector('#closeBtn');
						if (closeButton) {
							closeButton.addEventListener('click', function () {
								infowindow.close();
							});
						}
					}
				});

			};
		};

		/* 다른 검색시 기존 배열에 담은 마커 초기화 */
		function removeMarkers() {
			markers.forEach((marker) => {
				marker.setMap(null);
			});
			markers = [];
		}

		/* 다른 검색시 기존 배열에 담은 인포윈도우 닫기 */
		function removeInfowindows() {
			infowindows.forEach((infowindow) => {
				infowindow.close();
			});
			infowindows = [];
		};


		/* db 데이터 가져오기 */
		/*function getDataFromDB(map, params) {
			$.ajax({
				type: 'GET',
				url: '/store/listto',
				data: params,
				dataType: 'json',
				success: function (data) {
					removeMarkers();
					var filteredData = data.filter(paging => paging.storeName.includes(params.keywords) || paging.storeAddress.includes(params.keywords));
					if (filteredData.length === 0) {
						alert('검색 결과가 없습니다.');
					} else {
						for (list of filteredData) {
							createMarkerAndInfoWindow(map, list, params);
						}
					}
				},
				error: function (request, status, error) {
					console.log(request, status, error)
				}
			})
		}*/

		/*function getDataFromDB(map) {
			var keywords = $('#keywords').val(); // 검색어 텍스트 필드에서 값을 가져옵니다.
			var searchField = $('input[name="searchField"]:checked').val(); // 선택된 검색 필드 값을 가져옵니다.

			var params = {
				keywords: keywords,
				searchField: searchField
			};

			$.ajax({
				type: 'GET',
				url: '/store/listto',
				data: params,
				dataType: 'json',
				success: function (data) {
					// 성공적으로 데이터를 받아왔을 때의 처리 로직
				},
				error: function (request, status, error) {
					// 요청이 실패했을 때의 처리 로직
				}
			});
		}
		*/
		/* form의 keywords를 기반으로 db 가져오기 */
		$('#search-form').on('submit', function (e) {
			e.preventDefault();
			var keywords = $('#search-input').val();
			if (keywords === '') {
				alert('검색어를 입력해주세요.');
				return;
			}
			var table = document.getElementById("table");
			table.innerHTML = '';
			removeInfowindows();

			getDataFromDB(map, {keywords: keywords});

		});
	});

</script>
</th:bolck>
</html>